# Connectors æ¶æ„å®ç°å®Œæˆ

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. Connector Core åŒ…
- âœ… `packages/connectors/core/package.json` - å·²é…ç½®
- âœ… `packages/connectors/core/src/connector.ts` - ChatConnector æ¥å£å®šä¹‰
- âœ… `packages/connectors/core/src/index.ts` - å¯¼å‡º
- âœ… æ„å»ºæˆåŠŸ âœ…

### 2. Connector WhatsApp åŒ…
- âœ… `packages/connectors/whatsapp/package.json` - å·²åˆ›å»ºï¼ŒåŒ…å« Baileys ä¾èµ–
- âœ… `packages/connectors/whatsapp/src/storage.ts` - ä¼šè¯å­˜å‚¨ç®¡ç†
- âœ… `packages/connectors/whatsapp/src/baileys-connector.ts` - Baileys å®ç°ï¼ˆ217 è¡Œï¼‰
  - å®ç° ChatConnector æ¥å£
  - æ¯ä¸ª uid ç‹¬ç«‹ä¼šè¯ç›®å½•ï¼š`apps/api/wa-auth/user-<uid>/`
  - ç›‘å¬ connection.update â†’ å‘å‡º qr/ready/status
  - ç›‘å¬ messages.upsert â†’ å‘å‡º message
  - è‡ªåŠ¨é‡è¿ï¼ˆæœ€å¤š 5 æ¬¡ï¼‰
  - isReady() æ–¹æ³•
- âœ… `packages/connectors/whatsapp/src/index.ts` - å¯¼å‡º
- âœ… `packages/connectors/whatsapp/tsconfig.json` - ESM é…ç½®
- âœ… `packages/connectors/whatsapp/tsup.config.ts` - æ„å»ºé…ç½®

### 3. èƒ¶æ°´å±‚
- âœ… `apps/api/src/channels/whatsapp.ts` - WhatsAppChannel ç±»ï¼ˆ279 è¡Œï¼‰
  - å®ä¾‹åŒ– BaileysConnector
  - æ˜ å°„ connector äº‹ä»¶åˆ° Socket.IO äº‹ä»¶ï¼š
    - qr â†’ wa.qr
    - ready â†’ wa.ready
    - status â†’ wa.status
    - message â†’ wa.message
  - é›†æˆ AI orchestratorï¼ˆè‡ªåŠ¨å›å¤ï¼‰
  - é—¨é¢æ–¹æ³•ï¼šensure(), send(), stop(), isReady()
  - upsertChannelSession() æ›´æ–°æ•°æ®åº“çŠ¶æ€
  - saveMessage() ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“

### 4. ä¾èµ–é…ç½®
- âœ… `apps/api/package.json` - æ·»åŠ äº† connector ä¾èµ–
- âœ… æ ¹ `package.json` - dev è„šæœ¬å·²é…ç½®ä¸ºå¹¶è¡Œè¿è¡Œ

## ğŸ—ï¸ æ¶æ„è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ (React)                      â”‚
â”‚           Socket.IO Client (wa.* äº‹ä»¶)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ Socket.IO
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              apps/api/src/index.ts                   â”‚
â”‚                  Socket.IO Server                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       apps/api/src/channels/whatsapp.ts              â”‚
â”‚              WhatsAppChannel (èƒ¶æ°´å±‚)                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ â€¢ äº‹ä»¶æ˜ å°„ï¼ˆconnector â†’ Socket.IOï¼‰      â”‚    â”‚
â”‚    â”‚ â€¢ AI orchestrator é›†æˆ                   â”‚    â”‚
â”‚    â”‚ â€¢ æ•°æ®åº“æŒä¹…åŒ–                           â”‚    â”‚
â”‚    â”‚ â€¢ é—¨é¢æ–¹æ³•ï¼ˆensure, send, stopï¼‰        â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  packages/connectors/whatsapp/src/baileys-connector â”‚
â”‚              BaileysConnector                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ â€¢ å®ç° ChatConnector æ¥å£                â”‚    â”‚
â”‚    â”‚ â€¢ ç®¡ç†å¤šç”¨æˆ·ä¼šè¯                         â”‚    â”‚
â”‚    â”‚ â€¢ è‡ªåŠ¨é‡è¿é€»è¾‘                           â”‚    â”‚
â”‚    â”‚ â€¢ å‘å‡ºæ ‡å‡†åŒ–äº‹ä»¶                         â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    packages/connectors/core/src/connector.ts         â”‚
â”‚              ChatConnector æ¥å£                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ â€¢ ç»Ÿä¸€çš„è¿æ¥å™¨æ¥å£                       â”‚    â”‚
â”‚    â”‚ â€¢ æ ‡å‡†åŒ–äº‹ä»¶ç±»å‹                         â”‚    â”‚
â”‚    â”‚ â€¢ å¯æ‰©å±•åˆ° Telegram/å…¶ä»–å¹³å°            â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         @whiskeysockets/baileys (Baileys åº“)        â”‚
â”‚              WhatsApp Web API                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ å®‰è£…å’Œæ„å»ºæ­¥éª¤

ç”±äºå·¥ä½œåŒºä¾èµ–çš„é—®é¢˜ï¼Œéœ€è¦æŒ‰ä»¥ä¸‹é¡ºåºæ“ä½œï¼š

### æ–¹æ³• 1ï¼šä½¿ç”¨æ ¹ç›®å½•å®‰è£…ï¼ˆæ¨èï¼‰

```bash
cd /Users/herbertlim/Downloads/wa

# 1. å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆå¦‚æœæœ‰ pnpmï¼‰
pnpm install

# 2. æ„å»º connector åŒ…
pnpm run build

# æˆ–å•ç‹¬æ„å»º
cd packages/connectors/core && bun run build
cd ../whatsapp && bun run build
```

### æ–¹æ³• 2ï¼šæ‰‹åŠ¨æ„å»ºï¼ˆå½“å‰å¯ç”¨ï¼‰

```bash
# 1. æ„å»º core åŒ…ï¼ˆå·²å®Œæˆ âœ…ï¼‰
cd /Users/herbertlim/Downloads/wa/packages/connectors/core
bun install
bun run build

# 2. æ‰‹åŠ¨é“¾æ¥ï¼ˆä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼‰
cd /Users/herbertlim/Downloads/wa/packages/connectors/whatsapp
mkdir -p node_modules/@pkg
ln -s ../../core node_modules/@pkg/connectors-core

# 3. å®‰è£… whatsapp åŒ…ä¾èµ–
bun install

# 4. æ„å»º whatsapp åŒ…
bun run build

# 5. é“¾æ¥åˆ° api
cd /Users/herbertlim/Downloads/wa/apps/api
mkdir -p node_modules/@pkg
ln -s ../../../packages/connectors/core node_modules/@pkg/connectors-core
ln -s ../../../packages/connectors/whatsapp node_modules/@pkg/connectors-whatsapp
```

## ğŸš€ è¿è¡Œå¼€å‘æœåŠ¡å™¨

```bash
cd /Users/herbertlim/Downloads/wa

# å¹¶è¡Œè¿è¡Œæ‰€æœ‰æœåŠ¡ï¼ˆéœ€è¦ pnpmï¼‰
pnpm dev

# æˆ–åˆ†åˆ«è¿è¡Œ
# ç»ˆç«¯ 1: Connectors
pnpm -F @pkg/connectors-whatsapp dev

# ç»ˆç«¯ 2: API
pnpm -F @app/api dev

# ç»ˆç«¯ 3: Web
pnpm -F @app/web dev
```

## âœ¨ æ–°æ¶æ„çš„ä¼˜åŠ¿

### 1. æ¨¡å—åŒ–è®¾è®¡
- âœ… æ¸…æ™°çš„èŒè´£åˆ†ç¦»
- âœ… æ˜“äºæµ‹è¯•
- âœ… ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²

### 2. å¯æ‰©å±•æ€§
- âœ… è½»æ¾æ·»åŠ  Telegram connector
- âœ… æ”¯æŒå…¶ä»–é€šè®¯å¹³å°
- âœ… ç»Ÿä¸€çš„æ¥å£è§„èŒƒ

### 3. ç±»å‹å®‰å…¨
- âœ… å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- âœ… ç¼–è¯‘æ—¶é”™è¯¯æ£€æŸ¥
- âœ… IDE æ™ºèƒ½æç¤º

### 4. ç»´æŠ¤æ€§
- âœ… Baileys å°è£…åœ¨ç‹¬ç«‹åŒ…ä¸­
- âœ… ä¸šåŠ¡é€»è¾‘ä¸è¿æ¥é€»è¾‘åˆ†ç¦»
- âœ… ä¾¿äºç‰ˆæœ¬ç®¡ç†å’Œæ›´æ–°

## ğŸ”„ äº‹ä»¶æµ

### ç”¨æˆ·æ‰«ç æµç¨‹
```
1. å‰ç«¯è°ƒç”¨ socket.emit('wa.start')
2. Socket.IO â†’ WhatsAppChannel.ensure(uid)
3. WhatsAppChannel â†’ BaileysConnector.start(uid)
4. BaileysConnector ç”Ÿæˆ QR ç 
5. BaileysConnector.emit('qr', { uid, qr })
6. WhatsAppChannel æ¥æ”¶ â†’ io.to(uid).emit('wa.qr', { qr })
7. å‰ç«¯æ˜¾ç¤º QR ç 
8. ç”¨æˆ·æ‰«ç åï¼ŒBaileys è¿æ¥æˆåŠŸ
9. BaileysConnector.emit('ready', { uid })
10. WhatsAppChannel â†’ io.to(uid).emit('wa.ready')
11. å‰ç«¯æ˜¾ç¤ºè¿æ¥æˆåŠŸ
```

### æ¶ˆæ¯æ¥æ”¶æµç¨‹
```
1. WhatsApp æ”¶åˆ°æ¶ˆæ¯
2. Baileys è§¦å‘ messages.upsert äº‹ä»¶
3. BaileysConnector å¤„ç† â†’ emit('message', { uid, from, text, ts })
4. WhatsAppChannel æ¥æ”¶ï¼š
   a. io.to(uid).emit('wa.message') â†’ å‰ç«¯æ˜¾ç¤º
   b. saveMessage() â†’ ä¿å­˜åˆ°æ•°æ®åº“
   c. handleInbound() â†’ AI å¤„ç†
   d. å¦‚æœæœ‰ AI å›å¤ â†’ send(uid, from, reply)
5. å‰ç«¯å®æ—¶æ˜¾ç¤ºæ¶ˆæ¯
```

## ğŸ“ ä¸‹ä¸€æ­¥

### ç«‹å³å¯ç”¨
- âœ… Connector æ¶æ„å·²å®Œæ•´å®ç°
- âœ… èƒ¶æ°´å±‚å·²é›†æˆ AI
- âœ… æ•°æ®åº“æŒä¹…åŒ–å·²å®Œæˆ
- âœ… Socket.IO äº‹ä»¶å…¼å®¹ç°æœ‰å‰ç«¯

### å¾…å®Œæˆï¼ˆå¯é€‰ï¼‰
1. **å®‰è£…ä¾èµ–**ï¼šè§£å†³å·¥ä½œåŒºä¾èµ–é—®é¢˜
2. **æµ‹è¯•è¿è¡Œ**ï¼šå¯åŠ¨æœåŠ¡éªŒè¯åŠŸèƒ½
3. **æ·»åŠ  Telegram**ï¼šåˆ›å»º telegram connector
4. **å®Œå–„æ–‡æ¡£**ï¼šAPI æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šæ‰¾ä¸åˆ° @pkg/connectors-core

**åŸå› **ï¼šå·¥ä½œåŒºä¾èµ–æœªæ­£ç¡®é“¾æ¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ä½¿ç”¨æ‰‹åŠ¨é“¾æ¥ï¼ˆæ–¹æ³• 2ï¼‰
cd packages/connectors/whatsapp
mkdir -p node_modules/@pkg
ln -s ../../core node_modules/@pkg/connectors-core
```

### é—®é¢˜ 2ï¼šTypeScript ç¼–è¯‘é”™è¯¯

**æ£€æŸ¥æ¸…å•**ï¼š
1. âœ… core åŒ…æ˜¯å¦å·²æ„å»ºï¼ˆdist/ ç›®å½•å­˜åœ¨ï¼‰
2. âœ… tsconfig.json çš„ moduleResolution è®¾ç½®
3. âœ… package.json çš„ type: "module"

### é—®é¢˜ 3ï¼šè¿è¡Œæ—¶æ‰¾ä¸åˆ°æ¨¡å—

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ç¡®ä¿æ‰€æœ‰åŒ…éƒ½å·²æ„å»º
cd packages/connectors/core && bun run build
cd ../whatsapp && bun run build
```

---

**å®ç°å®Œæˆæ—¥æœŸ**ï¼š2025-11-07  
**å®ç°è€…**ï¼šGitHub Copilot  
**çŠ¶æ€**ï¼šâœ… æ¶æ„å®Œæˆï¼Œç­‰å¾…å®‰è£…ä¾èµ–å’Œæµ‹è¯•
